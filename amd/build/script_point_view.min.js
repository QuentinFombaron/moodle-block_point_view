define(["jquery","core/ajax","core/notification"],function(a,b,c){function d(b,c){var d=a("#module-"+b+" .block_point_view.reactions-container");return void 0===c?d:d.find(c)}var e={none:0,easy:1,better:2,hard:3},f={};function g(g,j,k,l){j.forEach(function(j){var m=parseInt(j.cmid),n=parseInt(j.uservote);if(f[m]=n,1===a("#module-"+m).length&&0===d(m).length){a("#module-"+m).prepend(k);var o=!1;d(m,".reaction img").click(function(){!1===o&&(o=!0,function(a,d,g){var h=e[g],j=f[d],k=h===j?e.none:h;return b.call([{methodname:"block_point_view_update_db",args:{func:"update",courseid:a,cmid:d,vote:k}}])[0].done(function(){if(f[d]=k,j!==e.none){var a=["","easy","better","hard"][j];i(d,a,-1,!1)}k!==e.none&&i(d,g,1,!0)}).fail(c.exception)}(g,m,a(this).data("reactionname")).always(function(){o=!1,h(m,l)}))}),d(m,".reactionnb").each(function(){var b=a(this).data("reactionname"),c=parseInt(j["total"+b]);i(m,b,c,n===e[b])}),h(m,l),function(b){var c=function(a){return{top:15-10*a,left:10-10*a,height:20*a}},e=function(a){return{left:10*a-10,height:20*a}},f=!1,g=null,h=null,i=function(){h=null,f=!1,function(b){["hard","better","easy"].forEach(function(e,f){var g=50+250*f;d(b,'.reaction img[data-reactionname="'+e+'"]').css({"pointer-events":"none"}).delay(g).animate(c(0),500),d(b,'.reactionnb[data-reactionname="'+e+'"]').delay(g).queue(function(b){a(this).removeClass("shown"),b()})}),d(b,".group_img").delay(500).show(0).animate(e(1),300).css({"pointer-events":"auto"}),d(b,".group_nb").delay(600).show(0),a("#module-"+b+" .actions").delay(600).show(300)}(b)},j=function(){g=null,f=!0,function(b){d(b,".group_img").css({"pointer-events":"none"}).animate(e(0),300).hide(0),d(b,".group_nb").delay(200).hide(300),a("#module-"+b+" .actions").delay(200).hide(300),["easy","better","hard"].forEach(function(e,f){var g=50+150*f;d(b,'.reaction img[data-reactionname="'+e+'"]').delay(g).animate(c(1),300).css({"pointer-events":"auto"}),d(b,'.reactionnb[data-reactionname="'+e+'"]').delay(g+300).queue(function(b){a(this).addClass("shown"),b()})})}(b),clearTimeout(h),h=setTimeout(i,2e3)};d(b,".group_img").mouseover(function(){a(this).stop().animate(e(1.15),100),g=setTimeout(j,300)}).mouseout(function(){f||(clearTimeout(g),a(this).stop().animate(e(1),100))}).click(j),d(b,".reaction img").mouseover(function(){a(this).stop().animate(c(2),100)}).mouseout(function(){a(this).stop().animate(c(1),100)}),d(b,".reactions").mouseout(function(){clearTimeout(h),h=setTimeout(i,1e3)}).mouseover(function(){clearTimeout(h)})}(m)}})}function h(b,c){var g="group_",h=0;d(b,".reactionnb").each(function(){var b=parseInt(a(this).text());b>0&&(g+=a(this).data("reactionname").toUpperCase().charAt(0)),h+=b}),d(b,".group_img").attr("src",c[g]);var i=d(b,".group_nb"),j=i.find("span");j.text(h).attr("title",M.util.get_string("totalreactions","block_point_view",h)),i.toggleClass("novote",0===h).toggleClass("voted",f[b]!==e.none);var k=Math.min((""+h).length,5);j.css({right:Math.max(.25*(k-2),0)+"em",transform:"scaleX("+(1+.03*k*k-.35*k+.34)+")"})}function i(a,b,c,e){var f=d(a,'.reactionnb[data-reactionname="'+b+'"]'),g=parseInt(f.text())+c;f.text(g).toggleClass("nbselected",e),d(a,'.reaction img[data-reactionname="'+b+'"]').toggleClass("novote",0===g)}return{init:function(b){a(function(){var c,d=a(".block_point_view[data-blockdata]").data("blockdata");(c=function(){var c,e;c=d.difficultylevels,e=d.trackcolors,c.forEach(function(b){var c=parseInt(b.difficultyLevel),d="";if(c>0){var f=["greentrack","bluetrack","redtrack","blacktrack"][c-1];d=M.util.get_string(f,"block_point_view")}var g=a("<div>",{class:"block_point_view track",title:d,style:"background-color: "+e[c]+";"}),h=a("#module-"+b.id+" .mod-indent-outer");0===h.find(".block_point_view.track").length&&h.prepend(g),h.find(".mod-indent").after(g)}),g(b,d.moduleswithreactions,d.reactionstemplate,d.pix)})(),a(document).ajaxComplete(function(a,b,d){if(void 0!==d.data){var e=JSON.parse(d.data);e.length>0&&void 0!==e[0].methodname&&("format_tiles_get_single_section_page_html"!=e[0].methodname&&"format_tiles_log_tile_click"!=e[0].methodname||c())}}),a(".activity").mouseover(function(){a(this).css({background:"linear-gradient(to right, rgba(0,0,0,0.04), rgba(0,0,0,0.04), transparent)","border-radius":"5px"})}).mouseout(function(){a(this).css({background:""})})})}}});